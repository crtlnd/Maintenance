const axios = require('axios');
const GOOGLE_MAPS_API_KEY = process.env.GOOGLE_MAPS_API_KEY;
const BASE_URL = 'https://maps.googleapis.com/maps/api/place/nearbysearch/json';

console.log('Environment in scrapeProviders:', {
  GOOGLE_MAPS_API_KEY: process.env.GOOGLE_MAPS_API_KEY,
  NODE_ENV: process.env.NODE_ENV,
});

async function fetchProviders(location, radius, serviceType) {
  if (!GOOGLE_MAPS_API_KEY) {
    console.error('GOOGLE_MAPS_API_KEY is not defined, returning mock data');
    return [
      {
        id: 1,
        name: 'Midland Maintenance Co.',
        description: `Top maintenance services in ${location.split(',')[0]}`,
        services: ['General Maintenance', 'HVAC Repair'],
        address: '123 Industrial Dr, Midland, TX 79701',
        phone: '(432) 555-1234',
        type: 'independent',
        pricing: 'mid-range',
        distance: 2.5,
        rating: 4.5,
        reviewCount: 50,
        availability: 'business hours',
        specializations: ['HVAC Systems'],
        certifications: ['Certified Technician'],
        website: 'https://example.com/midland-maintenance',
        placeId: 'mock_place_id_1',
      },
      {
        id: 2,
        name: 'Texas Repair Pros',
        description: `Electrical and hydraulic services in ${location.split(',')[0]}`,
        services: ['Electrical Maintenance', 'Hydraulic Repair'],
        address: '456 Oilfield Rd, Midland, TX 79705',
        phone: '(432) 555-5678',
        type: 'specialized',
        pricing: 'premium',
        distance: 1.8,
        rating: 4.8,
        reviewCount: 75,
        availability: '24/7',
        specializations: ['Electrical Systems', 'Hydraulic Systems'],
        certifications: ['Master Electrician'],
        website: 'https://example.com/texas-repair',
        placeId: 'mock_place_id_2',
      },
    ];
  }

  try {
    console.log('Making API request with params:', {
      key: GOOGLE_MAPS_API_KEY,
      location,
      radius: radius * 1609.34,
      keyword: serviceType,
      type: 'business',
    });

    const response = await axios.get(BASE_URL, {
      params: {
        key: GOOGLE_MAPS_API_KEY,
        location: location,
        radius: radius * 1609.34,
        keyword: serviceType,
        type: 'business',
      },
    });

    const providers = response.data.results.map((place, index) => ({
      id: index + 1,
      name: place.name || 'Unknown Provider',
      description: `Maintenance services provider in ${location.split(',')[0]}`,
      services: [serviceType.charAt(0).toUpperCase() + serviceType.slice(1)],
      address: place.vicinity || 'Unknown Address',
      phone: 'Unknown Phone',
      type: place.types.includes('repair') ? 'specialized' : 'independent',
      pricing: 'mid-range',
      distance: Math.random() * radius,
      rating: place.rating || 4.0 + Math.random(),
      reviewCount: place.user_ratings_total || Math.floor(Math.random() * 100),
      availability: 'business hours',
      specializations: [serviceType],
      certifications: [],
      website: place.website || null,
      placeId: place.place_id,
    }));

    if (providers.length === 0) {
      console.log(`No providers found for ${serviceType} in ${location}, returning mock data`);
      return [
        {
          id: 1,
          name: 'Midland Maintenance Co.',
          description: `Top maintenance services in ${location.split(',')[0]}`,
          services: ['General Maintenance', 'HVAC Repair'],
          address: '123 Industrial Dr, Midland, TX 79701',
          phone: '(432) 555-1234',
          type: 'independent',
          pricing: 'mid-range',
          distance: 2.5,
          rating: 4.5,
          reviewCount: 50,
          availability: 'business hours',
          specializations: ['HVAC Systems'],
          certifications: ['Certified Technician'],
          website: 'https://example.com/midland-maintenance',
          placeId: 'mock_place_id_1',
        },
        {
          id: 2,
          name: 'Texas Repair Pros',
          description: `Electrical and hydraulic services in ${location.split(',')[0]}`,
          services: ['Electrical Maintenance', 'Hydraulic Repair'],
          address: '456 Oilfield Rd, Midland, TX 79705',
          phone: '(432) 555-5678',
          type: 'specialized',
          pricing: 'premium',
          distance: 1.8,
          rating: 4.8,
          reviewCount: 75,
          availability: '24/7',
          specializations: ['Electrical Systems', 'Hydraulic Systems'],
          certifications: ['Master Electrician'],
          website: 'https://example.com/texas-repair',
          placeId: 'mock_place_id_2',
        },
      ];
    }

    console.log(`Providers fetched: ${providers.length}`);
    return providers;
  } catch (error) {
    console.error('Error fetching providers:', error.message, error.response?.data);
    return [
      {
        id: 1,
        name: 'Midland Maintenance Co.',
        description: `Top maintenance services in ${location.split(',')[0]}`,
        services: ['General Maintenance', 'HVAC Repair'],
        address: '123 Industrial Dr, Midland, TX 79701',
        phone: '(432) 555-1234',
        type: 'independent',
        pricing: 'mid-range',
        distance: 2.5,
        rating: 4.5,
        reviewCount: 50,
        availability: 'business hours',
        specializations: ['HVAC Systems'],
        certifications: ['Certified Technician'],
        website: 'https://example.com/midland-maintenance',
        placeId: 'mock_place_id_1',
      },
      {
        id: 2,
        name: 'Texas Repair Pros',
        description: `Electrical and hydraulic services in ${location.split(',')[0]}`,
        services: ['Electrical Maintenance', 'Hydraulic Repair'],
        address: '456 Oilfield Rd, Midland, TX 79705',
        phone: '(432) 555-5678',
        type: 'specialized',
        pricing: 'premium',
        distance: 1.8,
        rating: 4.8,
        reviewCount: 75,
        availability: '24/7',
        specializations: ['Electrical Systems', 'Hydraulic Systems'],
        certifications: ['Master Electrician'],
        website: 'https://example.com/texas-repair',
        placeId: 'mock_place_id_2',
      },
    ];
  }
}

module.exports = { fetchProviders };
